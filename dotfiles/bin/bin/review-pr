#!/usr/bin/env bash
#
# review-pr - Select a PR with fzf and review it with amp
#
# Usage:
#   review-pr         # List open PRs, select with fzf, review in amp
#
# Must be run from within a git repository.
#

set -euo pipefail

# Detect repo from current directory
REPO=$(gh repo view --json nameWithOwner -q '.nameWithOwner' 2>/dev/null) || {
  echo "Error: Not in a git repository or unable to detect repo." >&2
  exit 1
}

# Fetch PRs sorted by updated date (most recent first)
prs=$(gh pr list \
  --state open \
  --limit 50 \
  --json number,title,updatedAt,author \
  --jq '.[] | "\(.number)\t\(.title)\t\(.updatedAt | split("T")[0])\t\(.author.login)"' \
  | sort -t$'\t' -k3 -r)

if [[ -z "$prs" ]]; then
  echo "No open PRs found in $REPO" >&2
  exit 0
fi

# Use fzf to select a PR
selected=$(echo "$prs" | awk -F'\t' '{printf "#%-6s %-60s (%s by %s)\n", $1, substr($2, 1, 60), $3, $4}' | \
  fzf --height=50% \
      --reverse \
      --header="Select a PR to review (sorted by last updated)" \
      --preview="gh pr view {1}" \
      --preview-window=right:50%:wrap)

if [[ -z "$selected" ]]; then
  echo "No PR selected" >&2
  exit 0
fi

# Extract PR number from selection (remove the # prefix)
pr_number=$(echo "$selected" | awk '{print $1}' | tr -d '#')

echo "Starting review for PR #$pr_number..."

# Start amp with the review prompt
# Permissions are configured in ~/.config/amp/settings.json to allow all actions
echo "Use the review-pr command to review PR #$pr_number" | exec amp
