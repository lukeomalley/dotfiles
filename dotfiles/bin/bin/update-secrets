#!/bin/bash
set -e

# Path to template and output
TEMPLATE_FILE="${ZDOTDIR:-$HOME/.config/zsh}/secrets.tpl"
OUTPUT_FILE="${ZDOTDIR:-$HOME/.config/zsh}/secrets.zsh"

if ! command -v op &> /dev/null; then
    echo "Error: 1Password CLI (op) is not installed."
    exit 1
fi

if [ ! -f "$TEMPLATE_FILE" ]; then
    echo "Error: Template file not found at $TEMPLATE_FILE"
    exit 1
fi

echo "Generating secrets from $TEMPLATE_FILE..."

# Check for 1Password session
if ! op account list &> /dev/null; then
    echo "Please sign in to 1Password:"
    eval $(op signin)
fi

# Inject secrets
op inject -i "$TEMPLATE_FILE" -o "$OUTPUT_FILE"

# Secure the file
chmod 600 "$OUTPUT_FILE"

echo "Secrets updated successfully at $OUTPUT_FILE"
echo "Remember to restart your shell or run 'source $OUTPUT_FILE' to apply changes."

